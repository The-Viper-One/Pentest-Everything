# BloodHound

{% hint style="warning" %}
Not yet implemented
{% endhint %}

## Description

PsMapExec facilitates the creation of cipher queries that can be easily inserted into the BloodHound GUI. When employing PsMapExec, cipher queries are automatically compiled into files located in $PWD\PME\BloodHound.&#x20;

Three distinct query files are created, one for designating ownership of either users or computers in BloodHound, and another for establishing RDP connections between users and computers. These query files are continuously updated while using PsMapExec throughout an engagement, gradually expanding in content.

&#x20;These queries are populated under the following circumstances during PsMapExec execution.

* Successful password or hash spraying will populate queries for marking these users as owned
* Accessible  or successful command execution against a target will build queries for marking these as owned
* Successful RDP access to targets will build a relationship edge between the supplied username and target system for "CanRDP"
* Parsed compromised users from the modules LogonPasswords and eKeys will mark these users as owned

## Examples

### Users

When password or hash spraying  a query file will be built for successfully sprayed users

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

The  UserQuery.txt file will then be populated:

```
MATCH (u:User) WHERE
u.name="ADMINISTRATOR@SECURITY.LOCAL" OR
u.name="ARBITER@SECURITY.LOCAL" OR
u.name="YAP-YAP@SECURITY.LOCAL" OR
u.name="CHIEF@SECURITY.LOCAL" OR
u.name="PLACEHOLDER@PLACEHOLDER.LOCAL"
SET u.owned=true
RETURN u
```

Which can then be pasted directly into the BloodHound GUI to mark the respective users as "owned"

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

###

### Users - Compromised

Users parsed from the module eKeys and LogonPasswords will be added to the user query file to be marked as owned

<figure><img src="../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

The  UserQuery.txt file will then be populated with the parsed usernames

```
MATCH (u:User) WHERE
u.name="CHIEF@SECURITY.LOCAL" OR
u.name="ARBITER@SECURITY.LOCAL" OR
u.name="ADMINISTRATOR@SECURITY.LOCAL" OR
u.name="PLACEHOLDER@PLACEHOLDER.LOCAL"
SET u.owned=true
RETURN u
```

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

###



### Computers

Confirmed access or command execution against systems with PsMapExec will populate the computer query file to mark those systems as owned.

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

the ComputerQuery.txt file will then be populated

```
MATCH (c:Computer) WHERE
c.name="SRV2019.SECURITY.LOCAL" OR
c.name="DC01.SECURITY.LOCAL" OR
c.name="PLACEHOLDER.PLACEHOLDER.LOCAL"
SET c.owned=true
RETURN c
```

<figure><img src="../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

###

### RDP

Successfully confirming RDP access via the RDP method will populate the RDPQuery.txt file that builds an RDP edge relationship between the supplied Username and target systems. This will also mark the user as owned in the event its not already.

Target systems will not be marked as owned with the RDP query file as RDP access is not equal to admin privileges.

<figure><img src="../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

The RDPQuery.txt will then be populated

```
MATCH (CHIEF:User {name: 'CHIEF@SECURITY.LOCAL'}), (SRV2019:Computer {name: 'SRV2019.SECURITY.LOCAL'})
MERGE (CHIEF)-[:CanRDP]->(SRV2019)
SET CHIEF.owned = true
WITH CHIEF, SRV2019
MATCH (CHIEF:User {name: 'CHIEF@SECURITY.LOCAL'}), (DC01:Computer {name: 'DC01.SECURITY.LOCAL'})
MERGE (CHIEF)-[:CanRDP]->(DC01)
SET CHIEF.owned = true
WITH CHIEF, DC01
MATCH (placeholderUser:User {name: 'PLACEHOLDER@PLACEHOLDER.LOCAL'}), (placeholderComputer:Computer {name: 'PLACEHOLDER.PLACEHOLDER.LOCAL'}) MERGE (placeholderUser)-[:CanRDP]->(placeholderComputer) SET placeholderUser.owned = true
```

Pasting this into BloodHound will report "No Data returned from query" which just means the query was successful but, we are not showing the results on screen

Checking a target node shows the RDP edge was added successfully.&#x20;

<figure><img src="../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>
